<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - Klinik Fisioterapi</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <style>
        :root {
            --primary-purple: #667eea;
            --primary-purple-dark: #764ba2;
            --light-bg: #f7fafc;
            --border-color: #dee2e6;
            --text-dark: #212529;
            --text-muted: #6c757d;
            --primary-blue: #007BFF;
            --primary-blue-dark: #0056b3;
            --success-green: #28a745;
            --danger-red: #dc3545;
            --warning-yellow: #ffc107;
            --info-blue: #17a2b8;
            --white: #ffffff;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Inter', sans-serif; 
            background: #f0f2f5;
            min-height: 100vh; 
            padding: 20px; 
            color: var(--text-dark); 
        }
        .container-main { max-width: 1400px; margin: 0 auto; }
        .card-dashboard { 
            background: white; 
            border-radius: 24px; 
            padding: 40px; 
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05); 
        }
        h1 { font-size: 2.25rem; font-weight: 700; }
        .header-section {
            display: flex; justify-content: space-between; align-items: center;
            flex-wrap: wrap; gap: 16px; margin-bottom: 32px;
            border-bottom: 1px solid var(--border-color); padding-bottom: 24px;
        }
        .btn-logout {
            background-color: #f56565; color: white; border: none; padding: 10px 20px;
            border-radius: 8px; font-weight: 600; transition: background-color 0.3s ease;
        }
        .btn-logout:hover { background-color: #e53e3e; }
        .filter-controls {
            display: flex; flex-wrap: wrap; gap: 16px; margin-bottom: 24px; align-items: center;
        }
        .form-control, .form-select { border-radius: 10px; }
        .table-responsive { border-radius: 16px; overflow: hidden; border: 1px solid var(--border-color); }
        .table { margin-bottom: 0; }
        .table th, .table td { vertical-align: middle; padding: 1rem; }
        .table thead { background-color: var(--primary-blue); color: var(--white); }
        .table tbody tr:hover { background-color: #e2e6ea; }
        
        .badge-custom { 
            padding: 8px 12px; 
            border-radius: 12px; 
            font-weight: 600; 
            font-size: 0.8em; 
            line-height: 1.2;
            display: inline-block;
        }
        .badge-umum { background-color: var(--success-green); color: var(--white); }
        .badge-disabilitas-sktm { background-color: var(--primary-blue); color: var(--white); }
        .badge-disabilitas-non-sktm { background-color: var(--info-blue); color: var(--white); }
        .badge-selesai { background-color: #2f855a; color: var(--white); }

        .badge-Belum-Diperiksa { background-color: var(--warning-yellow); color: var(--text-dark); }
        .badge-Sedang-Diperiksa { background-color: #4a5568; color: var(--white); }
        .badge-Selesai { background-color: #2f855a; color: var(--white); }

        .btn-sm-modern { border-radius: 8px; font-weight: 600; padding: 8px 16px; transition: all 0.3s ease; }
        .btn-info-modern { background-color: var(--info-blue); border: none; color: var(--white); }
        .btn-info-modern:hover { background-color: #117a8b; }
        .btn-details {
            background-color: var(--info-blue);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        .btn-details:hover { 
            background-color: #117a8b;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .modal-header { 
            background: linear-gradient(135deg, var(--primary-purple), var(--primary-purple-dark)); 
            color: white; 
            border-bottom: none;
            display: flex;
            align-items: center;
        }
        .modal-header img {
            height: 32px; 
            margin-right: 12px;
        }
        .uploaded-file-display img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin-top: 8px;
            border: 1px solid var(--border-color);
            cursor: pointer;
        }
        .list-group-flush .list-group-item {
            padding-left: 0;
            padding-right: 0;
            border-color: #f0f2f5;
        }
        .list-group-flush .list-group-item strong.text-end {
            flex-shrink: 0;
            margin-left: 1rem;
            text-align: right;
            word-break: break-word;
        }
        .list-group-flush .list-group-item span {
            flex-shrink: 1;
        }
        .modal-title-logo {
            font-size: 1.5rem;
            font-weight: 700;
            margin-left: 1rem;
        }
        .badge-break { white-space: pre-wrap; }
        
        .hidden { display: none !important; } /* Menambahkan class hidden */
        .btn-close-white { filter: invert(1) grayscale(100%) brightness(200%); } /* Menambahkan class btn-close-white */
    </style>
</head>
<body>

    <div class="container-main">
        <div class="card-dashboard">
            <div class="header-section">
                <div><h1>Dashboard Admin</h1><p class="text-muted mb-0">Data Pendaftaran Pasien (Real-time)</p></div>
                <div class="d-flex align-items-center gap-3">
                    <div id="total-display" class="total-display"><span>Total Pendaftaran: <span id="total-count">0</span></span></div>
                    <button id="btn-logout" class="btn-logout"><i class="fas fa-sign-out-alt me-2"></i>Logout</button>
                </div>
            </div>

            <div class="filter-controls">
                <input type="text" id="search-input" class="form-control" placeholder="Cari nama pasien..." style="max-width: 300px;">
                
                <select id="filter-category" class="form-select" style="width: 220px;">
                    <option value="all">Semua Kategori</option>
                    <option value="disabilitas-sktm">Disabilitas (SKTM)</option>
                    <option value="disabilitas-non-sktm">Disabilitas (Non-SKTM)</option>
                    <option value="umum">Masyarakat Umum</option>
                </select>

                <select id="filter-status" class="form-select" style="width: 200px;">
                    <option value="all">Semua Status</option>
                    <option value="Belum Diperiksa">Belum Diperiksa</option>
                    <option value="Sedang Diperiksa">Sedang Diperiksa</option>
                    <option value="Selesai">Selesai</option>
                </select>
                <input type="date" id="filter-date" class="form-control" style="width: 200px;">
                <button id="reset-filters" class="btn btn-secondary">Reset Filter</button>
            </div>

            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>No Antrian</th>
                            <th>Nama Pasien</th>
                            <th>Jadwal</th>
                            <th>Keluhan</th>
                            <th>Jenis Disabilitas / Layanan</th>
                            <th>Kategori</th>
                            <th>Status</th>
                            <th class="text-center">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="registration-table-body">
                        <tr id="loading-row">
                            <td colspan="8" class="text-center p-5">
                                <div class="spinner-border text-primary"></div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal fade" id="detail-modal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title d-flex align-items-center">
                        <img src="https://agent48.site/assets/mac/logoklinik.png" alt="Logo Klinik" class="me-2">
                        Detail Pendaftaran Pasien
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="mb-3">Informasi Personal</h6>
                            <dl class="row mb-0">
                                <dt class="col-sm-5 detail-label">Nama Pasien</dt>
                                <dd class="col-sm-7 detail-value" id="detail-name"></dd>
                                <dt class="col-sm-5 detail-label">Tanggal Lahir</dt>
                                <dd class="col-sm-7 detail-value" id="detail-dob"></dd>
                                <dt class="col-sm-5 detail-label">Jenis Kelamin</dt>
                                <dd class="col-sm-7 detail-value" id="detail-gender"></dd>
                                <dt class="col-sm-5 detail-label">No. HP/WA</dt>
                                <dd class="col-sm-7 detail-value" id="detail-phone"></dd>
                                <dt class="col-sm-5 detail-label">Alamat</dt>
                                <dd class="col-sm-7 detail-value" id="detail-address"></dd>
                                <dt class="col-sm-5 detail-label">Nama Wali</dt>
                                <dd class="col-sm-7 detail-value" id="detail-guardian-name"></dd>
                            </dl>
                        </div>
                        <div class="col-md-6">
                            <h6 class="mb-3">Informasi Pendaftaran</h6>
                            <dl class="row mb-0">
                                <dt class="col-sm-5 detail-label">Nomor Antrian</dt>
                                <dd class="col-sm-7 detail-value" id="detail-queue-number"></dd>
                                <dt class="col-sm-5 detail-label">Jadwal Kunjungan</dt>
                                <dd class="col-sm-7 detail-value" id="detail-schedule"></dd>
                                <dt class="col-sm-5 detail-label">Jenis Disabilitas / Layanan</dt>
                                <dd class="col-sm-7 detail-value" id="detail-disability-type"></dd>
                                <dt class="col-sm-5 detail-label">Keluhan</dt>
                                <dd class="col-sm-7 detail-value" id="detail-complaint"></dd>
                                <dt class="col-sm-5 detail-label">Kategori</dt>
                                <dd class="col-sm-7 detail-value" id="detail-category"></dd>
                                <dt class="col-sm-5 detail-label">Status</dt>
                                <dd class="col-sm-7 detail-value" id="detail-status"></dd>
                            </dl>
                        </div>
                    </div>
                    <hr class="my-4">
                    <div class="row">
                        <div class="col-12">
                            <h6 class="mb-3">Dokumen</h6>
                            <dl class="row mb-0">
                                <dt class="col-sm-5 detail-label" id="detail-sktm-row">Dokumen SKTM</dt>
                                <dd class="col-sm-7 detail-value" id="detail-sktm-display"></dd>
                                <dt class="col-sm-5 detail-label">Bukti Pembayaran</dt>
                                <dd class="col-sm-7 detail-value" id="detail-payment-proof-display"></dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-database-compat.js"></script>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyB-zS7qBYN9riG58CxcdoTew_DH_wHrFpA",
            authDomain: "projek-link.firebaseapp.com",
            databaseURL: "https://projek-link-default-rtdb.asia-southeast1.firebasedatabase.app",
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const registrationsRef = db.ref('pendaftaran');
        
        const tableBody = document.getElementById('registration-table-body');
        const searchInput = document.getElementById('search-input');
        const categoryFilter = document.getElementById('filter-category');
        const statusFilter = document.getElementById('filter-status');
        const dateFilter = document.getElementById('filter-date');
        const resetFiltersBtn = document.getElementById('reset-filters');
        const totalCountEl = document.getElementById('total-count');
        const detailModal = new bootstrap.Modal(document.getElementById('detail-modal'));
        const logoutBtn = document.getElementById('btn-logout');
        let allRegistrations = []; 

        const formatDate = (ds, opt={}) => new Date(ds).toLocaleDateString('id-ID', {timeZone:'Asia/Jakarta', ...opt});
        
        const renderTable = (data) => {
            tableBody.innerHTML = ''; 
            if (data.length === 0) { 
                tableBody.innerHTML = `<tr><td colspan="8" class="text-center p-4">Data tidak ditemukan.</td></tr>`; 
                return; 
            }
            data.forEach((reg) => {
                const categoryClass = {
                    'disabilitas-sktm': 'badge-disabilitas-sktm',
                    'disabilitas-non-sktm': 'badge-disabilitas-non-sktm',
                    'umum': 'badge-umum'
                }[reg.category] || 'badge-selesai';
                
                const categoryText = {
                    'disabilitas-sktm': 'Disabilitas<br>(SKTM)',
                    'disabilitas-non-sktm': 'Disabilitas<br>(Non-SKTM)',
                    'umum': 'Masyarakat<br>Umum'
                }[reg.category] || reg.category || 'N/A';
                
                const categoryBadge = `<span class="badge-custom ${categoryClass} badge-break">${categoryText}</span>`;
                
                const statusClass = reg.status ? `badge-${reg.status.replace(/\s/g, '-')}` : 'badge-selesai';
                
                let statusText = reg.status ? reg.status.toUpperCase() : 'N/A';
                if (statusText === 'BELUM DIPERIKSA') {
                    statusText = 'BELUM<br>DIPERIKSA';
                } else if (statusText === 'SEDANG DIPERIKSA') {
                    statusText = 'SEDANG<br>DIPERIKSA';
                }
                
                const statusBadge = `<span class="badge-custom ${statusClass} badge-break">${statusText}</span>`;

                const complaintPreview = reg.complaint && reg.complaint.length > 30 ? reg.complaint.substring(0, 30) + '...' : (reg.complaint || '-');
                
                tableBody.innerHTML += `
                    <tr>
                        <td>${reg.queueNumber || 'N/A'}</td>
                        <td><strong>${reg.fullName || 'N/A'}</strong></td>
                        <td>${formatDate(reg.date, {weekday:'short',day:'numeric',month:'short'})}, ${reg.time || ''}</td>
                        <td class="complaint-cell" title="${reg.complaint || ''}">${complaintPreview}</td>
                        <td>${reg.disabilityType || '-'}</td>
                        <td>${categoryBadge}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <div class="d-flex flex-nowrap gap-2">
                                <button class="btn btn-sm btn-info-modern detail-btn" data-id="${reg.id}">
                                    <i class="fas fa-eye"></i> Detail
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
        };

        const updateView = () => {
            const searchTerm = searchInput.value.toLowerCase();
            const selectedCategory = categoryFilter.value;
            const selectedStatus = statusFilter.value;
            const selectedDate = dateFilter.value;

            const filteredData = allRegistrations.filter(reg => {
                const matchesSearch = reg.fullName && reg.fullName.toLowerCase().includes(searchTerm);
                const matchesCategory = selectedCategory === 'all' || reg.category === selectedCategory;
                const matchesStatus = selectedStatus === 'all' || (reg.status && reg.status === selectedStatus);
                const matchesDate = !selectedDate || reg.date === selectedDate;
                
                return matchesSearch && matchesCategory && matchesStatus && matchesDate;
            });
            renderTable(filteredData);
        };

        registrationsRef.on('value', (snapshot) => {
            const loadingRow = document.getElementById('loading-row');
            if (loadingRow) {
                loadingRow.style.display = 'none';
            }
            if (snapshot.exists()) {
                const data = snapshot.val();
                allRegistrations = Object.keys(data).map(key => ({ id: key, ...data[key] })).reverse();
                totalCountEl.textContent = allRegistrations.length;
                updateView();
            } else {
                totalCountEl.textContent = '0';
                tableBody.innerHTML = `<tr><td colspan="8" class="text-center p-4">Belum ada data pendaftaran.</td></tr>`;
            }
        });

        [searchInput, categoryFilter, statusFilter, dateFilter].forEach(el => el.addEventListener('input', updateView));
        resetFiltersBtn.addEventListener('click', () => {
            searchInput.value = ''; categoryFilter.value = 'all'; statusFilter.value = 'all'; dateFilter.value = '';
            updateView();
        });
        logoutBtn.addEventListener('click', () => { window.location.href = 'index.html'; });

        const renderFileDisplay = (fileUrl, displayElement) => {
            if (!fileUrl) {
                displayElement.innerHTML = '<span class="text-muted">Tidak diunggah</span>';
                return;
            }
            const isImage = /\.(jpg|jpeg|png|gif)$/i.test(fileUrl);
            if (isImage) {
                displayElement.innerHTML = `<img src="${fileUrl}" alt="File yang diunggah" onclick="window.open('${fileUrl}', '_blank')">`;
            } else {
                displayElement.innerHTML = `<a href="${fileUrl}" target="_blank" class="btn btn-outline-primary">Lihat File <i class="fas fa-external-link-alt fa-xs"></i></a>`;
            }
        };

        tableBody.addEventListener('click', (e) => {
            if (e.target.closest('.detail-btn')) {
                const regId = e.target.closest('.detail-btn').dataset.id;
                const regData = allRegistrations.find(reg => reg.id === regId);
                if (regData) {
                    // Update personal info
                    document.getElementById('detail-name').textContent = regData.fullName || 'N/A';
                    document.getElementById('detail-dob').textContent = formatDate(regData.dob, { day: 'numeric', month: 'long', year: 'numeric' });
                    document.getElementById('detail-gender').textContent = regData.gender || 'N/A';
                    document.getElementById('detail-phone').textContent = regData.phone || 'N/A';
                    document.getElementById('detail-address').textContent = regData.address || 'N/A';
                    document.getElementById('detail-guardian-name').textContent = regData.guardianName || 'N/A';

                    // Update registration info
                    document.getElementById('detail-queue-number').textContent = regData.queueNumber || 'N/A';
                    document.getElementById('detail-schedule').textContent = `${formatDate(regData.date, {weekday:'long',day:'numeric',month:'long',year:'numeric'})}, ${regData.time || ''}`;
                    document.getElementById('detail-disability-type').textContent = regData.disabilityType || 'Tidak ada';
                    document.getElementById('detail-complaint').textContent = regData.complaint || 'Tidak ada';
                    document.getElementById('detail-category').textContent = {
                        'disabilitas-sktm': 'Disabilitas (SKTM)',
                        'disabilitas-non-sktm': 'Disabilitas (Non-SKTM)',
                        'umum': 'Masyarakat Umum'
                    }[regData.category] || 'N/A';
                    document.getElementById('detail-status').textContent = regData.status ? regData.status.toUpperCase() : 'N/A';

                    // Show/hide SKTM section
                    const sktmRow = document.getElementById('detail-sktm-row');
                    const sktmDisplay = document.getElementById('detail-sktm-display');
                    if (regData.category === 'disabilitas-sktm') {
                        sktmRow.classList.remove('hidden');
                        sktmDisplay.classList.remove('hidden');
                        renderFileDisplay(regData.sktmFileUrl, sktmDisplay);
                    } else {
                        sktmRow.classList.add('hidden');
                        sktmDisplay.classList.add('hidden');
                    }

                    // Render payment proof file
                    renderFileDisplay(regData.paymentProofFileUrl, document.getElementById('detail-payment-proof-display'));

                    detailModal.show();
                }
            }
        });
    </script>
</body>
</html>
