<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - Klinik Fisioterapi</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <style>
        :root {
            --primary-purple: #667eea;
            --primary-purple-dark: #764ba2;
            --light-bg: #f7fafc;
            --border-color: #e2e8f0;
            --text-dark: #2d3748;
            --text-muted: #718096;
            --primary-blue: #007BFF;
            --primary-blue-dark: #0056b3;
            --success-green: #28a745;
            --danger-red: #dc3545;
            --warning-yellow: #ffc107;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Inter', sans-serif; 
            background: #f0f2f5;
            min-height: 100vh; 
            padding: 20px; 
            color: var(--text-dark); 
        }
        .container-main { max-width: 1400px; margin: 0 auto; }
        .card-dashboard { 
            background: white; 
            border-radius: 24px; 
            padding: 40px; 
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05); 
        }
        h1 { font-size: 2.25rem; font-weight: 700; }
        .header-section {
            display: flex; justify-content: space-between; align-items: center;
            flex-wrap: wrap; gap: 16px; margin-bottom: 32px;
            border-bottom: 1px solid var(--border-color); padding-bottom: 24px;
        }
        .btn-logout {
            background-color: #f56565; color: white; border: none; padding: 10px 20px;
            border-radius: 8px; font-weight: 600; transition: background-color 0.3s ease;
        }
        .btn-logout:hover { background-color: #e53e3e; }
        .filter-controls {
            display: flex; flex-wrap: wrap; gap: 16px; margin-bottom: 24px; align-items: center;
        }
        .form-control, .form-select { border-radius: 10px; }
        .table { border-collapse: separate; border-spacing: 0 8px; }
        .table th {
            font-weight: 600; color: var(--text-muted); text-transform: uppercase; 
            font-size: 0.8rem; padding: 12px 16px; text-align: left;
            border-bottom: 2px solid var(--border-color);
        }
        .table td { background: var(--light-bg); padding: 16px; vertical-align: middle; }
        .table tr:hover td { background-color: #edf2f7; }
        .table td:first-child { border-radius: 12px 0 0 12px; }
        .table td:last-child { border-radius: 0 12px 12px 0; text-align: center; }
        .badge-custom { padding: 6px 12px; border-radius: 50px; font-weight: 600; font-size: 0.8rem; }
        
        .badge-umum { background-color: rgba(72, 187, 120, 0.2); color: #2f855a; }
        .badge-disabilitas-sktm { background-color: rgba(102, 126, 234, 0.2); color: #4c51bf; }
        .badge-disabilitas-non-sktm { background-color: rgba(56, 178, 172, 0.2); color: #234e52; }
        
        /* Updated Status Badges */
        .badge-Belum-Diperiksa { background-color: var(--warning-yellow); color: var(--text-dark); }
        .badge-Sedang-Diperiksa { background-color: var(--primary-blue); color: var(--white); }
        .badge-Selesai { background-color: var(--success-green); color: var(--white); }

        .btn-details {
            background: none; border: 2px solid #cbd5e0; color: #4a5568;
            border-radius: 8px; padding: 6px 12px; font-weight: 600;
            cursor: pointer; transition: all 0.2s ease;
        }
        .btn-details:hover { background: var(--primary-purple); color: white; border-color: var(--primary-purple); }
        .modal-header { background: linear-gradient(135deg, var(--primary-purple), var(--primary-purple-dark)); color: white; }
        .uploaded-file-display img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin-top: 8px;
            border: 1px solid var(--border-color);
            cursor: pointer;
        }
    </style>
</head>
<body>

    <div class="container-main">
        <div class="card-dashboard">
            <div class="header-section">
                <div><h1>Dashboard Admin</h1><p class="text-muted mb-0">Data Pendaftaran Pasien (Real-time)</p></div>
                <div class="d-flex align-items-center gap-3">
                    <div id="total-display" class="total-display"><span>Total Pendaftaran: <span id="total-count">0</span></span></div>
                    <button id="btn-logout" class="btn-logout"><i class="fas fa-sign-out-alt me-2"></i>Logout</button>
                </div>
            </div>

            <div class="filter-controls">
                <input type="text" id="search-input" class="form-control" placeholder="Cari nama pasien..." style="max-width: 300px;">
                
                <select id="filter-category" class="form-select" style="width: 220px;">
                    <option value="all">Semua Kategori</option>
                    <option value="disabilitas-sktm">Disabilitas (SKTM)</option>
                    <option value="disabilitas-non-sktm">Disabilitas (Non-SKTM)</option>
                    <option value="umum">Masyarakat Umum</option>
                </select>

                <select id="filter-status" class="form-select" style="width: 200px;">
                    <option value="all">Semua Status</option>
                    <option value="Belum Diperiksa">Belum Diperiksa</option>
                    <option value="Sedang Diperiksa">Sedang Diperiksa</option>
                    <option value="Selesai">Selesai</option>
                </select>
                <input type="date" id="filter-date" class="form-control" style="width: 200px;">
                <button id="reset-filters" class="btn btn-secondary">Reset Filter</button>
            </div>

            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>No Antrian</th>
                            <th>Nama Pasien</th>
                            <th>Jadwal</th>
                            <th>Keluhan</th>
                            <th>Disabilitas</th>
                            <th>Kategori</th>
                            <th>Status</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="registration-table-body">
                        <tr id="loading-row">
                            <td colspan="8" class="text-center p-5">
                                <div class="spinner-border text-primary"></div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal fade" id="detail-modal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detail Pendaftaran Pasien</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between"><span>Nama Pasien:</span> <strong id="detail-name"></strong></li>
                        <li class="list-group-item d-flex justify-content-between"><span>Tgl Lahir:</span> <strong id="detail-dob"></strong></li>
                        <li class="list-group-item d-flex justify-content-between"><span>No. HP/WA:</span> <strong id="detail-phone"></strong></li>
                        <li class="list-group-item d-flex justify-content-between"><span>Jadwal Kunjungan:</span> <strong id="detail-schedule" class="text-end"></strong></li>
                        <li class="list-group-item d-flex flex-column"><span>Keluhan:</span> <strong id="detail-complaint" class="mt-1" style="text-align: right;"></strong></li>
                        <li class="list-group-item"><span>Bukti Pembayaran:</span><div id="detail-payment-proof-display" class="mt-2 text-end uploaded-file-display"></div></li>
                        <li class="list-group-item"><span>File SKTM/KKS:</span><div id="detail-sktm-display" class="mt-2 text-end uploaded-file-display"></div></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-database-compat.js"></script>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyB-zS7qBYN9riG58CxcdoTew_DH_wHrFpA",
            authDomain: "projek-link.firebaseapp.com",
            databaseURL: "https://projek-link-default-rtdb.asia-southeast1.firebasedatabase.app",
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const registrationsRef = db.ref('pendaftaran');
        
        const tableBody = document.getElementById('registration-table-body');
        const searchInput = document.getElementById('search-input');
        const categoryFilter = document.getElementById('filter-category');
        const statusFilter = document.getElementById('filter-status');
        const dateFilter = document.getElementById('filter-date');
        const resetFiltersBtn = document.getElementById('reset-filters');
        const totalCountEl = document.getElementById('total-count');
        const detailModal = new bootstrap.Modal(document.getElementById('detail-modal'));
        const logoutBtn = document.getElementById('btn-logout');
        let allRegistrations = []; 

        const formatDate = (ds, opt={}) => new Date(ds).toLocaleDateString('id-ID', {timeZone:'Asia/Jakarta', ...opt});
        
        const renderTable = (data) => {
            tableBody.innerHTML = ''; 
            if (data.length === 0) { 
                tableBody.innerHTML = `<tr><td colspan="8" class="text-center p-4">Data tidak ditemukan.</td></tr>`; 
                return; 
            }
            data.forEach((reg) => {
                const categoryBadgeClass = {
                    'disabilitas-sktm': 'badge-disabilitas-sktm',
                    'disabilitas-non-sktm': 'badge-disabilitas-non-sktm',
                    'umum': 'badge-umum'
                }[reg.category] || 'badge-selesai';
                const categoryText = {
                    'disabilitas-sktm': 'Disabilitas (SKTM)',
                    'disabilitas-non-sktm': 'Disabilitas (Non-SKTM)',
                    'umum': 'Masyarakat Umum'
                }[reg.category] || reg.category || 'N/A';
                const categoryBadge = `<span class="badge-custom ${categoryBadgeClass}">${categoryText}</span>`;
                
                const statusBadgeClass = reg.status ? `badge-${reg.status.replace(/\s/g, '-')}` : 'badge-selesai';
                const statusBadge = `<span class="badge-custom ${statusBadgeClass}">${reg.status ? reg.status.toUpperCase() : 'N/A'}</span>`;

                const complaintPreview = reg.complaint && reg.complaint.length > 30 ? reg.complaint.substring(0, 30) + '...' : (reg.complaint || '-');
                
                tableBody.innerHTML += `
                    <tr>
                        <td>${reg.queueNumber || 'N/A'}</td>
                        <td><strong>${reg.fullName || 'N/A'}</strong></td>
                        <td>${formatDate(reg.date, {weekday:'short',day:'numeric',month:'short'})}, ${reg.time || ''}</td>
                        <td class="complaint-cell" title="${reg.complaint || ''}">${complaintPreview}</td>
                        <td>${reg.disabilityType || '-'}</td>
                        <td>${categoryBadge}</td>
                        <td>${statusBadge}</td>
                        <td><button class="btn-details" data-id="${reg.id}">Detail</button></td>
                    </tr>
                `;
            });
        };

        const updateView = () => {
            const searchTerm = searchInput.value.toLowerCase();
            const selectedCategory = categoryFilter.value;
            const selectedStatus = statusFilter.value;
            const selectedDate = dateFilter.value;

            const filteredData = allRegistrations.filter(reg => {
                const matchesSearch = reg.fullName && reg.fullName.toLowerCase().includes(searchTerm);
                const matchesCategory = selectedCategory === 'all' || reg.category === selectedCategory;
                const matchesStatus = selectedStatus === 'all' || (reg.status && reg.status === selectedStatus);
                const matchesDate = !selectedDate || reg.date === selectedDate;
                
                return matchesSearch && matchesCategory && matchesStatus && matchesDate;
            });
            renderTable(filteredData);
        };

        // Ini adalah bagian yang diperbaiki. 
        // Fungsi on('value') akan dipanggil setiap kali ada perubahan pada database.
        // Di dalamnya, kita akan mengambil data terbaru dan memanggil updateView()
        // untuk menampilkan data yang sudah difilter.
        registrationsRef.on('value', (snapshot) => {
            document.getElementById('loading-row').style.display = 'none';
            if (snapshot.exists()) {
                const data = snapshot.val();
                allRegistrations = Object.keys(data).map(key => ({ id: key, ...data[key] })).reverse();
                totalCountEl.textContent = allRegistrations.length;
                updateView(); // Panggil updateView di dalam listener Firebase
            } else {
                totalCountEl.textContent = '0';
                tableBody.innerHTML = `<tr><td colspan="8" class="text-center p-4">Belum ada data pendaftaran.</td></tr>`;
            }
        });

        [searchInput, categoryFilter, statusFilter, dateFilter].forEach(el => el.addEventListener('input', updateView));
        resetFiltersBtn.addEventListener('click', () => {
            searchInput.value = ''; categoryFilter.value = 'all'; statusFilter.value = 'all'; dateFilter.value = '';
            updateView();
        });
        logoutBtn.addEventListener('click', () => { window.location.href = 'index.html'; });

        const renderFileDisplay = (fileUrl, displayElement) => {
            if (!fileUrl) {
                displayElement.innerHTML = '<span class="text-muted">Tidak diunggah</span>';
                return;
            }
            const isImage = /\.(jpg|jpeg|png|gif)$/i.test(fileUrl);
            if (isImage) {
                displayElement.innerHTML = `<img src="${fileUrl}" alt="File yang diunggah" onclick="window.open('${fileUrl}', '_blank')">`;
            } else {
                displayElement.innerHTML = `<a href="${fileUrl}" target="_blank" class="btn btn-outline-primary">Lihat File <i class="fas fa-external-link-alt fa-xs"></i></a>`;
            }
        };

        tableBody.addEventListener('click', (e) => {
            if (e.target.classList.contains('btn-details')) {
                const regId = e.target.dataset.id;
                const regData = allRegistrations.find(reg => reg.id === regId);
                if (regData) {
                    document.getElementById('detail-name').textContent = regData.fullName || 'N/A';
                    document.getElementById('detail-dob').textContent = formatDate(regData.dob, { day: 'numeric', month: 'long', year: 'numeric' });
                    document.getElementById('detail-phone').textContent = regData.phone || 'N/A';
                    document.getElementById('detail-schedule').textContent = `${formatDate(regData.date, {weekday:'long',day:'numeric',month:'long',year:'numeric'})}, ${regData.time || ''}`;
                    document.getElementById('detail-complaint').textContent = regData.complaint || 'Tidak ada';
                    renderFileDisplay(regData.paymentProofFileUrl, document.getElementById('detail-payment-proof-display'));
                    renderFileDisplay(regData.sktmFileUrl, document.getElementById('detail-sktm-display'));
                    detailModal.show();
                }
            }
        });
    </script>
</body>
</html>